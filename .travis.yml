
language: c

sudo: required

matrix:
  include:
    - os: linux
      compiler: gcc
    - os: osx
      compiler: clang

addons:
  apt:
    packages:
      # DRM
      - libdrm-dev
      # RANDR
      - libxcb1-dev
      - libxcb-randr0-dev
      # VidMode
      - libx11-dev
      - libxxf86vm-dev
      # GeoClue2
      - libglib2.0-dev

install:
  - |
    if [ "$TRAVIS_OS_NAME" == "osx" ]; then
      # Note: "brew update" and "brew install gettext" are not necessary and
      #       we can install needed packages with HOMEBREW_NO_AUTO_UPDATE=1.
      #       This reduces job time significantly.
      brew update
      brew install gettext
      brew link --force gettext
      # Building with Meson sometimes fails due to its regressions.
      # Meson can be installed via brew, but
      # we install it via pip to pin its version.
      # Meson uses Ninja and we install it via brew.
      brew install ninja
      # Note: No longer needed. Errors can be ignored.
      brew upgrade python || true
    fi
  - |
    if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      # We need to use newer versions of Ninja and gettext to
      # get Meson to work on Ubuntu 14.04 LTS (Trusty).

      # Ninja: From official GitHub repo, smaller than other versions
      ninja_url=https://github.com/ninja-build/ninja/releases/download/v1.5.3/ninja-linux.zip
      wget -O - "$ninja_url" | funzip > ninja
      sudo install -m 755 ninja /usr/bin

      # gettext and its dependencies: From Ubuntu 18.04 LTS (Bionic) mirror
      #   * Only msgfmt and xgettext need to be upgraded to 0.19.7+.
      #   * appdata.{its,loc} are needed too.
      gettext_url=http://us-central1.gce.archive.ubuntu.com/ubuntu/pool/main/g/gettext/gettext_0.19.8.1-6_amd64.deb
      libtinfo_url=http://us-central1.gce.archive.ubuntu.com/ubuntu/pool/main/n/ncurses/libtinfo5_6.1-1ubuntu1_amd64.deb
      libunistring_url=http://us-central1.gce.archive.ubuntu.com/ubuntu/pool/main/libu/libunistring/libunistring2_0.9.9-0ubuntu1_amd64.deb
      for url in "$gettext_url" "$libtinfo_url" "$libunistring_url"; do
        wget "$url"
      done
      ar p gettext*.deb data.tar.xz > gettext.tar.xz
      ar p libtinfo*.deb data.tar.xz > libtinfo.tar.xz
      ar p libunistring*.deb data.tar.xz > libunistring.tar.xz
      cmd="tar -C / -Jxf gettext.tar.xz"
      cmd="$cmd ./usr/bin/msgfmt"
      cmd="$cmd ./usr/bin/xgettext"
      cmd="$cmd ./usr/lib/x86_64-linux-gnu/libgettext{lib,src}{,-0.19.8.1}.so"
      cmd="$cmd ./usr/share/gettext-0.19.8/its/appdata.{its,loc} &&"
      cmd="$cmd tar -C / -Jxf libtinfo.tar.xz"
      cmd="$cmd ./lib/x86_64-linux-gnu/libtinfo.so.5{.9,} &&"
      cmd="$cmd tar -C / -Jxf libunistring.tar.xz"
      cmd="$cmd ./usr/lib/x86_64-linux-gnu/libunistring.so.2{.1.0,}"
      sudo bash -c "$cmd"

      # Set PATH to use Python 3.6 and Meson
      # Note: Python 3.6 is available without additional download.
      export PATH=~/virtualenv/python3.6/bin:~/.local/bin:$PATH
    fi
    # This version of Meson is already tested.
  - pip3 install meson==0.49.0

before_script:
  - |
    if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      CONF_FLAGS="--prefix=$TRAVIS_BUILD_DIR/root"
      CONF_FLAGS="$CONF_FLAGS -Ddrm=enabled -Drandr=enabled"
      CONF_FLAGS="$CONF_FLAGS -Dvidmode=enabled -Dquartz=disabled"
      CONF_FLAGS="$CONF_FLAGS -Dwingdi=disabled -Dgeoclue2=enabled"
      CONF_FLAGS="$CONF_FLAGS -Dcorelocation=disabled -Dgui=enabled"
      CONF_FLAGS="$CONF_FLAGS -Dubuntu=disabled -Dapparmor=enabled"
      export CONF_FLAGS
    fi
  - |
    if [ "$TRAVIS_OS_NAME" == "osx" ]; then
      CONF_FLAGS="--prefix=$TRAVIS_BUILD_DIR/root"
      CONF_FLAGS="$CONF_FLAGS -Ddrm=disabled -Drandr=disabled"
      CONF_FLAGS="$CONF_FLAGS -Dvidmode=disabled -Dquartz=enabled"
      CONF_FLAGS="$CONF_FLAGS -Dwingdi=disabled -Dgeoclue2=disabled"
      CONF_FLAGS="$CONF_FLAGS -Dcorelocation=enabled -Dgui=disabled"
      CONF_FLAGS="$CONF_FLAGS -Dubuntu=disabled -Dapparmor=disabled"
      export CONF_FLAGS
    fi

script:
  - meson $CONF_FLAGS _build
  - ninja -v -C _build install
  - ninja -v -C _build test
  - ninja -v -C _build dist
  # redshift tests
  - |
    "$TRAVIS_BUILD_DIR"/root/bin/redshift -l 12:-34 -pv
  - |
    "$TRAVIS_BUILD_DIR"/root/bin/redshift -l 12:-34 -m dummy -vo
  - |
    echo -e "[redshift]\ndawn-time=6:30\ndusk-time=18:00-19:30" > time.config
  - |
    "$TRAVIS_BUILD_DIR"/root/bin/redshift -c time.config -pv
  - |
    "$TRAVIS_BUILD_DIR"/root/bin/redshift -c time.config -m dummy -vo
